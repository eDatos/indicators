(function(i){if("undefined"==typeof istacUrl)throw"istacUrl not defined";"undefined"==typeof apiContext&&(apiContext=istacUrl+"/api/indicators/v1.0");var n=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b},j=!1,o=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,f=function(){};f.extend=function(a){function b(){!j&&this.init&&this.init.apply(this,arguments)}var c=this.prototype;j=!0;var e=new this;j=!1;for(var d in a)e[d]="function"==typeof a[d]&&"function"==typeof c[d]&&o.test(a[d])?
function(a,b){return function(){var d=this._super;this._super=c[a];var e=b.apply(this,arguments);this._super=d;return e}}(d,a[d]):a[d];b.prototype=e;b.prototype.constructor=b;b.extend=arguments.callee;return b};var m=f.extend({_cache:[],init:function(){this.data={};this.structure={}},fetch:function(a,b,c){var e=this;this.data={};this.structure={};var d=$.Deferred(),g=function(){c!==i&&c(e);d.resolve(e)};a==i||b==i?g():this._getDatasetFromCache(a,b)?g():this._getDatasetFromApi(a,b,g);return d.promise()},
getObservationIndex:function(a,b,c){for(var e=this.data,d=$.inArray("GEOGRAPHICAL",e.format),g=$.inArray("TIME",e.format),p=$.inArray("MEASURE",e.format),a=e.dimension.GEOGRAPHICAL.representation.index[a],b=e.dimension.TIME.representation.index[b],c=e.dimension.MEASURE.representation.index[c],h=1,f=[],l=e.format,k=0;k<l.length;k++)0<k&&(h*=e.dimension[l[l.length-k]].representation.size),f.unshift(h);return f[d]*a+f[g]*b+f[p]*c},_observationToNumber:function(a){if(a)return a=a.replace(".",""),a=a.replace(",",
"."),parseFloat(a)},getObservation:function(a,b,c){return this.data.observation?this._observationToNumber(this.data.observation[this.getObservationIndex(a,b,c)]):null},getTimeValues:function(){return this.data.dimension?n(this.data.dimension.TIME.representation.index):[]},getGeographicalValues:function(){return this.data.dimension?n(this.data.dimension.GEOGRAPHICAL.representation.index):[]},getLastTimeValue:function(){var a=this.getTimeValues();return 0<a.length?a[a.length-1]:null},_getCacheKey:function(a,
b){if(a!=i&&b!=i)return a+"#"+b},_getDatasetFromCache:function(a,b){var c=this._getCacheKey(a,b);return c&&(c=this._cache[c])?(this.data=c.data,this.structure=c.structure,!0):!1},_saveCache:function(a,b){this._cache[this._getCacheKey(a,b)]={data:this.data,structure:this.structure}},_getDatasetFromApi:function(a,b,c){var e=this,d=apiContext+"/indicatorsSystems/"+a+"/indicatorsInstances/"+b,g=d+"/data",d=$.ajax({url:d,dataType:"jsonp",jsonp:"_callback"}),g=$.ajax({url:g,dataType:"jsonp",jsonp:"_callback"});
d.success(function(a){e.structure=a});g.success(function(a){e.data=a});$.when(d,g).then(function(){e._saveCache(a,b);c()})}}),f=f.extend({_defaultOptions:{title:"default title",width:300,height:400,borderColor:"#3478B0",textColor:"#000000",indicators:[],measures:["ABSOLUTE","ANNUAL_PERCENTAGE_RATE","ANNUAL_PUNTUAL_RATE","INTERPERIOD_PERCENTAGE_RATE","INTERPERIOD_PUNTUAL_RATE"]},init:function(a){a=a||defaultOptions;this.el=$(a.el);this.systemId=a.systemId;this.indicators=a.indicators||[];this.measures=
a.measures||this._defaultOptions.measures;this.geographicalValues=a.geographicalValues;this.titleContainer=$('<div class="istac-widget-title"></div>');this.contentContainer=$('<div class="istac-widget-content"></div>');this.el.html(this.titleContainer).append(this.contentContainer);this.el.addClass("istac-widget");this.el.addClass(this.containerClass);this.setTextColor(a.textColor);this.setBorderColor(a.borderColor);this.setTitle(a.title);this.setWidth(a.width);this.apiUrl=a.apiUrl;this.render()},
setTextColor:function(a){this.textColor=a;this.el.css("color",a)},_getContrast50:function(a){if(a&&0<a.length)return"#"===a[0]&&(a=a.substring(1)),8388607.5<parseInt(a,16)?"#333":"white"},setBorderColor:function(a){this.borderColor=a;this.titleContainer.css("background-color",a);this.titleContainer.css("color",this._getContrast50(a));this.el.css("border-color",a)},setWidth:function(a){this.width=a;this.el.css("width",a)},setTitle:function(a){this.title=a;this.titleContainer.text(a)},setSystemId:function(a){this.systemId=
a;this.render()},setIndicators:function(a){this.indicators=a;this.render()},setMeasures:function(a){this.measures=a;this.render()},setGeographicalValues:function(a){this.geographicalValues=a;this.render()}}),q=f.extend({init:function(a){this._super(a)},setWidth:function(a){this._super(a);this.render()},parse:function(a){for(var b=this.measures[0],c=a.getTimeValues(),e=this.geographicalValues,d={},g={},f={},h=0;h<e.length;h++){var i="serie"+h,l=e[h];d[i]=l;f[i]=c;for(var k=[],j=0;j<c.length;j++){var m=
a.getObservation(l,c[j],b);k.push(m)}g[i]=k}this.renderChart({labels:c,values:g,legend:d,tooltips:f})},render:function(){var a=this,b=new m;b.fetch(a.systemId,a.indicators[0],function(){a.parse(b)})},renderChart:function(a){var b=$('<div id="chart"></div>');b.css("width",this.width);b.css("height",this.height);this.contentContainer.html(b);b.chart({type:"line",margins:[10,10,20,50],defaultSeries:{plotProps:{"stroke-width":4},dot:!0,dotProps:{stroke:"white","stroke-width":2}},series:{serie0:{color:"#3478B0"},
serie1:{color:"#EBCC5C"}},defaultAxis:{labels:!0},features:{grid:{draw:[!0,!1],props:{"stroke-dasharray":"-"}},legend:{horizontal:!1,width:80,height:50,x:this.width-80-20,y:220,dotType:"circle",dotProps:{stroke:"white","stroke-width":2},borderProps:{opacity:0.3,fill:"#c0c0c0","stroke-width":0,"stroke-opacity":0}}},width:this.width,height:400,labels:a.labels,values:a.values,legend:a.legend,tooltips:a.tooltips})}}),r={ABSOLUTE:"Absoluto",ANNUAL_PERCENTAGE_RATE:"Tasa porcentual interanual",ANNUAL_PUNTUAL_RATE:"Tasa puntual interanual",
INTERPERIOD_PERCENTAGE_RATE:"Tasa porcentual interperi\u00f3dica",INTERPERIOD_PUNTUAL_RATE:"Tasa puntual interperi\u00f3dica"},s=f.extend({containerClass:"istac-widget-lastData",init:function(a){this._super(a)},_renderTableColumn:function(a){return"<td>"+a+"</td>"},parse:function(a){for(var b=a.getLastTimeValue(),c=this.geographicalValues[0],e=[],d=0;d<this.measures.length;d++){var g=a.getObservation(c,b,this.measures[d]);e.push(g)}return{temporalValue:b,observations:e}},render:function(){for(var a=
this,b=[],c=[],e=a.systemId,d=a.indicators,g=0;g<d.length;g++){var f=new m,h=f.fetch(e,d[g]);b.push(f);c.push(h)}0<c.length?$.when.apply(this,c).then(function(){a.renderTable(b)}):a.renderTable(b)},renderTable:function(a){if(a){var b;b="<thead><tr><th></th>";for(var c=0;c<this.measures.length;c++)b+="<th>"+r[this.measures[c]]+"</th>";b+="</thead>";for(var e="",c=0;c<a.length;c++){for(var d=a[c],g=this.parse(d),d="<tr><th>"+d.structure.title.es+" ("+g.temporalValue+")</th>",g=g.observations,f=0;f<
g.length;f++)var h=g[f],h="undefined"===typeof h?"-":h,d=d+this._renderTableColumn(h);d+="</tr>";e+=d}this.contentContainer.html("<table>"+b+"<tbody>"+e+"</tbody></table>")}}}),f=function(a,b){if(a){var c=document.getElementsByTagName("head")[0],e=document.createElement("script");e.src=b;c.appendChild(e)}};(function(a,b){var c=document;if(!c.getElementById(a)){var e=c.getElementsByTagName("head")[0],c=c.createElement("link");c.id=a;c.rel="stylesheet";c.type="text/css";c.href=b;c.media="all";e.appendChild(c)}})("istac-widget-css",
istacUrl+"/theme/css/widgets.css");f(!window.jQuery,istacUrl+"/theme/js/widgets/libs/jquery-1.7.1.js");f(!window.Raphael,istacUrl+"/theme/js/widgets/libs/raphael-min.js");f(!(window.jQuery&&window.jQuery.elycharts),istacUrl+"/theme/js/widgets/libs/elycharts.min.js");window.IstacWidget=function(a){a=a||{};return"temporal"===a.type?new q(a):new s(a)};window.IstacDataset=m})();
