(function(l){var q=function(a){var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(d);return b},o=!1,u=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,k=function(){};k.extend=function(a){function b(){!o&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;o=!0;var c=new this;o=!1;for(var e in a)c[e]="function"==typeof a[e]&&"function"==typeof d[e]&&u.test(a[e])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);this._super=c;return e}}(e,a[e]):
a[e];b.prototype=c;b.prototype.constructor=b;b.extend=arguments.callee;return b};var p=k.extend({_cache:[],init:function(a){this.data={};this.structure={};this.apiUrl=a},fetch:function(a,b,d){var c=this;this.data={};this.structure={};var e=$.Deferred(),f=function(){d!==l&&d(c);e.resolve(c)};a==l||b==l?f():this._getDatasetFromCache(a,b)?f():this._getDatasetFromApi(a,b,f);return e.promise()},getObservationIndex:function(a,b,d){for(var c=this.data,e=$.inArray("GEOGRAPHICAL",c.format),f=$.inArray("TIME",
c.format),i=$.inArray("MEASURE",c.format),a=c.dimension.GEOGRAPHICAL.representation.index[a],b=c.dimension.TIME.representation.index[b],d=c.dimension.MEASURE.representation.index[d],g=1,j=[],h=c.format,m=0;m<h.length;m++)0<m&&(g*=c.dimension[h[h.length-m]].representation.size),j.unshift(g);return j[e]*a+j[f]*b+j[i]*d},_observationToNumber:function(a){if(a)return a=a.replace(".",""),a=a.replace(",","."),parseFloat(a)},getObservation:function(a,b,d){return this.data.observation?this._observationToNumber(this.data.observation[this.getObservationIndex(a,
b,d)]):null},_getTitles:function(a,b){var d={};if(a)for(var c=0;c<a.length;c++){var e=a[c],f=d,i=e.code;if(e.title[b])e=e.title[b];else{var e=e.title,g;g=e;var j=void 0,h=void 0;for(h in g)if(g.hasOwnProperty(h)){j=h;break}g=j;j=void 0;g&&(j=e[g]);e=j}f[i]=e}return d},getTimeValues:function(){var a;return this.data.dimension?(a=q(this.data.dimension.TIME.representation.index),a.sort()):[]},getTimeValuesTitles:function(a){return this.structure.dimension?this._getTitles(this.structure.dimension.TIME.representation,
a):[]},getGeographicalValues:function(){return this.data.dimension?q(this.data.dimension.GEOGRAPHICAL.representation.index):[]},getGeographicalValuesTitles:function(a){return this.structure.dimension?this._getTitles(this.structure.dimension.GEOGRAPHICAL.representation,a):[]},getLastTimeValue:function(){var a=this.getTimeValues();return 0<a.length?a[a.length-1]:null},_getCacheKey:function(a,b){if(a!=l&&b!=l)return a+"#"+b},_getDatasetFromCache:function(a,b){var d=this._getCacheKey(a,b);return d&&(d=
this._cache[d])?(this.data=d.data,this.structure=d.structure,!0):!1},_saveCache:function(a,b){this._cache[this._getCacheKey(a,b)]={data:this.data,structure:this.structure}},_getDatasetFromApi:function(a,b,d){var c=this,e=this.apiUrl+"/indicatorsSystems/"+a+"/indicatorsInstances/"+b,f=e+"/data",e=$.ajax({url:e,dataType:"jsonp",jsonp:"_callback"}),f=$.ajax({url:f,dataType:"jsonp",jsonp:"_callback"});e.success(function(a){c.structure=a});f.success(function(a){c.data=a});$.when(e,f).then(function(){c._saveCache(a,
b);d()})}}),k=k.extend({_defaultOptions:{title:"default title",width:300,height:400,borderColor:"#3478B0",textColor:"#000000",indicators:[],measures:["ABSOLUTE","ANNUAL_PERCENTAGE_RATE","ANNUAL_PUNTUAL_RATE","INTERPERIOD_PERCENTAGE_RATE","INTERPERIOD_PUNTUAL_RATE"],showLabels:!0,showLegend:!0},init:function(a){a=a||defaultOptions;this.el=$(a.el);this.type=a.type;this.systemId=a.systemId;this.indicators=a.indicators||[];this.measures=a.measures||this._defaultOptions.measures;this.geographicalValues=
a.geographicalValues;this.url=a.url||"";this.apiUrl=this.url+"/api/indicators/v1.0";this.locale=a.locale||"es";this.titleContainer=$('<div class="istac-widget-title"></div>');this.contentContainer=$('<div class="istac-widget-content"></div>');this.el.html(this.titleContainer).append(this.contentContainer);this.el.addClass("istac-widget");this.el.addClass(this.containerClass);this.isIstacDomain()||this.includeLogo();this.setTextColor(a.textColor);this.setBorderColor(a.borderColor);this.setTitle(a.title);
this.setWidth(a.width);this.setShowLabels(a.showLabels);this.setShowLegend(a.showLegend)},setShowLabels:function(a){this.showLabels=a;"temporal"===this.type&&this.render()},setShowLegend:function(a){this.showLegend=a;"temporal"===this.type&&this.render()},setTextColor:function(a){this.textColor=a;this.el.css("color",a)},_getContrast50:function(a){if(a&&0<a.length)return"#"===a[0]&&(a=a.substring(1)),8388607.5<parseInt(a,16)?"#333":"white"},setBorderColor:function(a){this.borderColor=a;this.titleContainer.css("background-color",
a);this.titleContainer.css("color",this._getContrast50(a));this.el.css("border-color",a)},setWidth:function(a){this.width=a;this.el.css("width",a)},setTitle:function(a){this.title=a;this.titleContainer.text(a)},setSystemId:function(a){this.systemId=a;this.render()},setIndicators:function(a){this.indicators=a;this.render()},setMeasures:function(a){this.measures=a;this.render()},setGeographicalValues:function(a){this.geographicalValues=a;this.render()},isIstacDomain:function(){var a=window.location.host,
b=this.url,d=document.createElement("a");d.href=b;return a===d.host},includeLogo:function(){this.el.append('<div class="istact-widget-footer"><a href="'+this.url+'">Widget facilitado por el ISTAC</a></div>')}}),s=k.extend({init:function(a){this._super(a)},setWidth:function(a){this._super(a)},parse:function(a){for(var b=this.locale,d=this.measures[0],c=a.getTimeValues(),e=a.getTimeValuesTitles(b),f=this.geographicalValues,i=a.getGeographicalValuesTitles(b),b={},g={},j={},h=0;h<f.length;h++){for(var m=
"serie"+h,k=f[h],l=i[k],o=[],p=[],n=0;n<c.length;n++){var r=c[n],q=a.getObservation(k,r,d);o.push(q);p.push(l+" - "+e[r]+" - "+q)}b[m]=l;g[m]=o;j[m]=p}a=Math.floor(c.length/5);d=[];for(h=0;h<c.length;h++)0===h%a?(r=c[h],d.push(e[r])):d.push("");return{labels:d,values:g,legend:b,tooltips:j}},render:function(){var a=this,b=new p(this.apiUrl);b.fetch(a.systemId,a.indicators[0],function(){var d=a.parse(b);a.renderChart(d)})},chartColors:function(){return{serie0:{color:"#4F81BD"},serie1:{color:"#FFC000"},
serie2:{color:"#92D050"},serie3:{color:"#F79646"},serie4:{color:"#C00000"},serie5:{color:"#8064A2"},serie6:{color:"#808080"},serie7:{color:"#00B0F0"}}},renderChart:function(a){var b=$('<div id="chart"></div>');b.css("width",this.width);b.css("height",this.height);this.contentContainer.html(b);var d=this.width,c={type:"line",margins:[20,20,40,50],defaultSeries:{plotProps:{"stroke-width":1},dot:!1,dotProps:{stroke:"white","stroke-width":2},tooltip:{active:!0,width:200,height:50,roundedCorners:5,padding:[6,
6],offset:[20,0],frameProps:{fill:"white","stroke-width":1},contentStyle:{"font-family":"Arial","font-size":"12px","line-height":"16px",color:"black"}}},series:this.chartColors(a),defaultAxis:{labels:!0,labelsDistance:20},features:{grid:{draw:[!0,!1],forceBorder:!0,props:{"stroke-dasharray":"-"}}},width:this.width,height:400,labels:a.labels,values:a.values,tooltips:a.tooltips};this.showLegend&&(c.features.legend={horizontal:!1,width:100,height:100,x:d-100-20,y:220,dotType:"circle",dotProps:{stroke:"white",
"stroke-width":2},borderProps:{opacity:0.3,fill:"#c0c0c0","stroke-width":0,"stroke-opacity":0}},c.legend=a.legend);this.showLabels||(c.axis={x:{labels:!1}});b.chart(c)}}),v={ABSOLUTE:"Absoluto",ANNUAL_PERCENTAGE_RATE:"Tasa porcentual interanual",ANNUAL_PUNTUAL_RATE:"Tasa puntual interanual",INTERPERIOD_PERCENTAGE_RATE:"Tasa porcentual interperi\u00f3dica",INTERPERIOD_PUNTUAL_RATE:"Tasa puntual interperi\u00f3dica"},t=k.extend({containerClass:"istac-widget-lastData",init:function(a){this._super(a)},
_renderTableColumn:function(a){return"<td>"+a+"</td>"},parse:function(a){for(var b=a.getLastTimeValue(),d=this.geographicalValues[0],c=[],e=0;e<this.measures.length;e++){var f=a.getObservation(d,b,this.measures[e]);c.push(f)}return{temporalValue:b,observations:c}},render:function(){for(var a=this,b=[],d=[],c=a.systemId,e=a.indicators,f=0;f<e.length;f++){var i=new p(this.apiUrl),g=i.fetch(c,e[f]);b.push(i);d.push(g)}0<d.length?$.when.apply(this,d).then(function(){a.renderTable(b)}):a.renderTable(b)},
renderTable:function(a){if(a){var b;b="<thead><tr><th></th>";for(var d=0;d<this.measures.length;d++)b+="<th>"+v[this.measures[d]]+"</th>";b+="</thead>";for(var c="",d=0;d<a.length;d++){for(var e=a[d],f=e.getTimeValuesTitles("es"),i=this.parse(e),e="<tr><th>"+e.structure.title.es+" ("+f[i.temporalValue]+")</th>",i=i.observations,f=0;f<i.length;f++)var g=i[f],g="undefined"===typeof g?"-":g,e=e+this._renderTableColumn(g);e+="</tr>";c+=e}this.contentContainer.html("<table>"+b+"<tbody>"+c+"</tbody></table>")}}}),
n=function(a,b){if(a){var d=document.getElementsByTagName("head")[0],c=document.createElement("script");c.src=b;d.appendChild(c)}};window.IstacWidgetTemporal=s;window.IstacWidgetLastData=t;window.IstacWidget=function(a){a=a||{};if(a.url){var b=a.url,d=b+"/theme/css/widgets.css",c=document;if(!c.getElementById("istac-widget-css")){var e=c.getElementsByTagName("head")[0],c=c.createElement("link");c.id="istac-widget-css";c.rel="stylesheet";c.type="text/css";c.href=d;c.media="all";e.appendChild(c)}n(!window.jQuery,
b+"/theme/js/widgets/libs/jquery-1.7.1.js");n(!window.Raphael,b+"/theme/js/widgets/libs/raphael-min.js");n(!(window.jQuery&&window.jQuery.elycharts),b+"/theme/js/widgets/libs/elycharts.min.js");a="temporal"===a.type?new s(a):new t(a);a.render();return a}$(a.el).text("Error, no se ha especificado la url del servicio web")};window.IstacDataset=p})();
