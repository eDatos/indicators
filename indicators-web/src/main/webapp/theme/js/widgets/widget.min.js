(function(a){function c(a,c){var d=10,e=20;c&&(b.text(c),a.hover(function(a){b.css("top",a.pageY-d+"px").css("left",a.pageX+e+"px").fadeIn("fast")},function(){b.fadeOut("fast")}),a.mousemove(function(a){b.css("top",a.pageY-d+"px").css("left",a.pageX+e+"px")}))}function d(a){a+="";var b=a.split(","),c=b[0],d=b.length>1?","+b[1]:"",e=/(\d+)(\d{3})/;while(e.test(c))c=c.replace(e,"$1.$2");return c+d}function e(a){var b=document.createElement("a");return b.href=a,b.host}var b=$('<p class="istact-widget-tooltip"></p>');$("body").append(b);var f=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},g=function(a){var b;for(var c in a)if(a.hasOwnProperty(c)){b=c;break}return b},h=function(a){var b=g(a),c;return b&&(c=a[b]),c},i=!1,j=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/,k=function(){};k.extend=function(a){function e(){!i&&this.init&&this.init.apply(this,arguments)}var b=this.prototype;i=!0;var c=new this;i=!1;for(var d in a)c[d]=typeof a[d]=="function"&&typeof b[d]=="function"&&j.test(a[d])?function(a,c){return function(){var d=this._super;this._super=b[a];var e=c.apply(this,arguments);return this._super=d,e}}(d,a[d]):a[d];return e.prototype=c,e.prototype.constructor=e,e.extend=arguments.callee,e};var l=function(a){this.data={},this.structure={},this.apiUrl=a};l._cache={},$.extend(l.prototype,{fetch:function(b,c,d){var e=this;this.systemid=b,this.indicatorid=c,this.data={},this.structure={};var f=$.Deferred(),g=function(){d!==a&&d(e),f.resolve(e)};return b==a||c==a?g():this._getDatasetFromCache(b,c)?g():this._getDatasetFromApi(b,c,g),f.promise()},getObservationIndex:function(a,b,c){var d=this.data,e=$.inArray("GEOGRAPHICAL",d.format),f=$.inArray("TIME",d.format),g=$.inArray("MEASURE",d.format),h=d.dimension.GEOGRAPHICAL.representation.index[a],i=d.dimension.TIME.representation.index[b],j=d.dimension.MEASURE.representation.index[c],k=1,l=[],m=d.format;for(var n=0;n<m.length;n++){if(n>0){var o=m[m.length-n];k*=d.dimension[o].representation.size}l.unshift(k)}var p=l[e]*h+l[f]*i+l[g]*j;return p},_observationToNumber:function(a){if(a)return parseFloat(a)},getObservation:function(a,b,c){if(this.data.observation){var d=this.getObservationIndex(a,b,c),e=this.data.observation[d],f=this._observationToNumber(e);return f}return null},getUnit:function(b,c,d){if(this.data.attribute){var e=this.getObservationIndex(b,c,d),f=this.data.attribute[e];if(f){var g="";return f.UNIT_MULT!==a&&f.UNIT_MULT.value.__default__!=="Unidades"&&(g=g+f.UNIT_MULT.value.__default__+" de "),g=g+f.UNIT_MEAS_DETAIL.value.__default__,g}}return""},getObservationStr:function(a,b,c){if(this.data.observation){var e=this.getObservationIndex(a,b,c),f=this.structure.decimalPlaces,g=this.data.observation[e],h;return g?(h=g,h=h.replace(".",","),h=d(h)):h="-",h}return null},_getTitles:function(a,b){var c={};if(a)for(var d=0;d<a.length;d++){var e=a[d];e.title[b]?c[e.code]=e.title[b]:c[e.code]=h(e.title)}return c},getDescription:function(){if(this.structure.conceptDescription)return this.structure.conceptDescription.__default__},getTimeValues:function(){var a;return this.data.dimension?(a=f(this.data.dimension.TIME.representation.index),a.sort()):[]},getTimeValuesTitles:function(a){return this.structure.dimension?this._getTitles(this.structure.dimension.TIME.representation,a):[]},getGeographicalValues:function(){return this.data.dimension?f(this.data.dimension.GEOGRAPHICAL.representation.index):[]},getGeographicalValuesTitles:function(a){return this.structure.dimension?this._getTitles(this.structure.dimension.GEOGRAPHICAL.representation,a):[]},getLastTimeValue:function(){var a=this.getTimeValues();return a.length>0?a[a.length-1]:null},_getCacheKey:function(b,c){if(b!=a&&c!=a)return b+"#"+c},_getDatasetFromCache:function(a,b){var c=this._getCacheKey(a,b);if(c){var d=l._cache[c];if(d)return this.data=d.data,this.structure=d.structure,!0}return!1},_saveCache:function(a,b){var c=this,d=c._getCacheKey(a,b);l._cache[d]={data:c.data,structure:c.structure}},_getDatasetFromApi:function(a,b,c){var d=this,e=this.apiUrl+"/indicatorsSystems/"+a+"/indicatorsInstances/"+b,f=e+"/data",g=$.ajax({url:e,dataType:"jsonp",jsonp:"_callback"}),h=$.ajax({url:f,dataType:"jsonp",jsonp:"_callback"});g.success(function(a){d.structure=a}),h.success(function(a){d.data=a}),$.when(g,h).then(function(){d._saveCache(a,b),c()})}});var m=k.extend({_defaultOptions:{title:"default title",width:300,height:400,borderColor:"#3478B0",textColor:"#000000",indicators:[],measures:["ABSOLUTE","ANNUAL_PERCENTAGE_RATE","ANNUAL_PUNTUAL_RATE","INTERPERIOD_PERCENTAGE_RATE","INTERPERIOD_PUNTUAL_RATE"],showLabels:!0,showLegend:!0},init:function(a){a=a||defaultOptions,this.el=$(a.el),this.type=a.type,this.systemId=a.systemId,this.indicators=a.indicators||[],this.measures=a.measures||this._defaultOptions.measures,this.geographicalValues=a.geographicalValues,this.url=a.url||"",this.apiUrl=this.url+"/api/indicators/v1.0",this.jaxiUrl=a.jaxiUrl||"",this.locale=a.locale||"es",this.titleLink=$('<a href="#" target="_blank"></a>'),this.titleContainer=$('<div class="istac-widget-title"></div>').append(this.titleLink),this.contentContainer=$('<div class="istac-widget-content"></div>'),this.el.html(this.titleContainer).append(this.contentContainer),this.el.addClass("istac-widget"),this.el.addClass(this.containerClass),this.isIstacDomain()||this.includeLogo(),this.setTextColor(a.textColor),this.setBorderColor(a.borderColor),this.setTitle(a.title),this.setWidth(a.width),this.setShowLabels(a.showLabels),this.setShowLegend(a.showLegend),this.setSystemId(a.systemId)},setShowLabels:function(a){this.showLabels=a},setShowLegend:function(a){this.showLegend=a},setTextColor:function(a){this.textColor=a,this.el.css("color",a)},_getContrast50:function(a){if(a&&a.length>0)return a[0]==="#"&&(a=a.substring(1)),parseInt(a,16)>8388607.5?"#333":"white"},setBorderColor:function(a){this.borderColor=a,this.titleContainer.css("background-color",a);var b=this._getContrast50(a);this.titleLink.css("color",b),this.el.css("border-color",a)},setWidth:function(a){this.width=a,this.el.css("width",a)},setTitle:function(a){this.title=a,this.titleLink.text(a)},setSystemId:function(a){this.systemId=a,this.titleLink.attr("href",this.url+"/indicatorsSystems/"+a)},setIndicators:function(a){this.indicators=a},setMeasures:function(a){this.measures=a},setGeographicalValues:function(a){this.geographicalValues=a},isIstacDomain:function(){if(this.url&&this.url.indexOf("http://")!==0)return!1;var a=window.location.host===e(this.url);return a},includeLogo:function(){this.el.append('<div class="istact-widget-footer"><a href="'+this.url+'/widgets/creator">Instituto Canario de Estadística (ISTAC)</a></div>')}}),n=m.extend({init:function(a){this._super(a)},setWidth:function(a){this._super(a)},parse:function(a){var b=this,c=this.locale,d=this.measures[0],e=a.getTimeValues(),f=a.getTimeValuesTitles(c),g=this.geographicalValues,h=a.getGeographicalValuesTitles(c),i={},j={},k={};for(var l=0;l<g.length;l++){var m="serie"+l,n=g[l],o=h[n],p=[],q=[];for(var r=0;r<e.length;r++){var s=e[r],t=a.getObservation(n,s,d),u=a.getObservationStr(n,s,d);p.push(t),q.push("<div>"+o+"</div><div>"+f[s]+"</div><div>"+u+"</div>")}i[m]=o,j[m]=p,k[m]=q}var v=5,w=Math.floor(e.length/v),x=[];for(var l=0;l<e.length;l++)if(l%w===0){var s=e[l];x.push(f[s])}else x.push("");var y={labels:x,values:j,legend:i,tooltips:k};return y},render:function(){var a=this,b=new l(this.apiUrl),c=a.indicators[0],d=a.systemId;b.fetch(d,c,function(){var c=a.parse(b);a.renderChart(c)})},chartColors:function(a){var b=a.tooltips.length,c={serie0:{color:"#4F81BD"},serie1:{color:"#FFC000"},serie2:{color:"#92D050"},serie3:{color:"#F79646"},serie4:{color:"#C00000"},serie5:{color:"#8064A2"},serie6:{color:"#808080"},serie7:{color:"#00B0F0"}};return c},renderChart:function(a){var b=$('<div id="chart"></div>');b.css("width",this.width-20),b.css("height",this.height),this.contentContainer.html(b);var c=a,d=this.chartColors(a),e=f(a.legend),g=this.width-20,h=200,i=this.width-20,j=this.showLegend?e.length*20:0,k=20,l=this.showLabels?40:10,m=k+h+l,n=j+l,o=k+h+n,p={type:"line",margins:[k,20,n,50],defaultSeries:{plotProps:{"stroke-width":1},dot:!1,dotProps:{stroke:"white","stroke-width":2},tooltip:{active:!0,width:200,height:60,roundedCorners:5,padding:[6,6],offset:[20,0],frameProps:{fill:"white","stroke-width":1},contentStyle:{"font-family":"Arial","font-size":"12px","line-height":"16px",color:"black"}}},series:d,defaultAxis:{labels:!0,labelsDistance:20},features:{grid:{draw:[!0,!1],forceBorder:!0,props:{"stroke-dasharray":"-"}}},width:g,height:o,labels:c.labels,values:c.values,tooltips:c.tooltips};this.showLegend&&(p.features.legend={width:i,height:j,x:0,y:m,dotType:"circle",dotProps:{stroke:"white","stroke-width":2},borderProps:{opacity:.3,fill:"#c0c0c0","stroke-width":0,"stroke-opacity":0}},p.legend=c.legend),this.showLabels||(p.axis={x:{labels:!1}}),b.chart(p)}}),o={ABSOLUTE:"Dato",ANNUAL_PERCENTAGE_RATE:"Tasa variación anual",ANNUAL_PUNTUAL_RATE:"Variación anual",INTERPERIOD_PERCENTAGE_RATE:"Tasa variación interperiódica",INTERPERIOD_PUNTUAL_RATE:"Variación interperiódica"},p=m.extend({containerClass:"istac-widget-lastData",init:function(a){this._super(a)},_renderTableColumn:function(a){return"<td>"+a+"</td>"},parse:function(a){var b=a.getLastTimeValue(),c=this.geographicalValues[0],d=[],e=[];for(var f=0;f<this.measures.length;f++){var g=this.measures[f],h=a.getObservationStr(c,b,g);typeof h=="undefined"&&(h="-");var i=a.getUnit(c,b,g);d.push({value:h,unit:i})}return{temporalValue:b,observations:d,units:e}},render:function(){var a=this,b=[],c=[],d=a.systemId,e=a.indicators;for(var f=0;f<e.length;f++){var g=new l(this.apiUrl),h=g.fetch(d,e[f]);b.push(g),c.push(h)}c.length>0?$.when.apply(this,c).then(function(){a.renderTable(b)}):a.renderTable(b)},renderTable:function(a){if(a){var b="<thead>";b+="<tr><th></th>";for(var d=0;d<this.measures.length;d++){var e=this.measures[d];b+="<th>"+o[e]+"</th>"}b+="</thead>";var f=$("<tbody></tbody>");for(var d=0;d<a.length;d++){var g=a[d],h=g.getTimeValuesTitles("es"),i=this.indicators[d],j=this.parse(g),k='<tr><th><div class="title"><a href="'+this.jaxiUrl+"/tabla.do?uuidInstanciaIndicador="+g.indicatorid+"&codigoSistemaIndicadores="+g.systemid+'&accion=html">'+g.structure.title.__default__+"</a>"+"</div>"+'<div class="unit">'+h[j.temporalValue]+"</div>"+"</th>",l=j.observations;for(var m=0;m<l.length;m++){var n=l[m];k+=this._renderTableColumn('<p class="istact-widget-observation">'+n.value+'</p><p class="istact-widget-unit">'+n.unit+"</p>")}k+="</tr>";var p=$(k);c(p,g.getDescription()),f.append(p)}var q=$("<table>"+b+"</table>").append(f);this.contentContainer.html(q)}}}),q=function(a,b){var c=document;if(!c.getElementById(a)){var d=c.getElementsByTagName("head")[0],e=c.createElement("link");e.id=a,e.rel="stylesheet",e.type="text/css",e.href=b,e.media="all",d.appendChild(e)}},r=function(a,b){if(a){var c=document.getElementsByTagName("head")[0],d=document.createElement("script");d.src=b,c.appendChild(d)}},s=function(a){q("istac-widget-css",a+"/theme/css/widgets.css"),r(!window.jQuery,a+"/theme/js/widgets/libs/jquery-1.7.1.js"),r(!window.Raphael,a+"/theme/js/widgets/libs/raphael-min.js"),r(!window.jQuery||!window.jQuery.elycharts,a+"/theme/js/widgets/libs/elycharts.min.js")},t=function(a){a=a||{};if(a.url){s(a.url);var b;return a.type==="temporal"?b=new n(a):b=new p(a),b.render(),b}$(a.el).text("Error, no se ha especificado la url del servicio web")};window.IstacWidgetTemporal=n,window.IstacWidgetLastData=p,window.IstacWidget=t,window.IstacDataset=l;var u=u||[];u.push(["_setAccount","UA-28460379-1"]),u.push(["_trackPageview"]),function(){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}()})();